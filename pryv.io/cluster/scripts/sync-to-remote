#!/usr/bin/env bash

# the first argument should be role to copy
# ex.: sync-files.sh core/reg-master/reg-slave

# the paths are currently hardcoded as they are not unified accross the remote hosts

if [ $1 != "cores" ] && [ $1 != "core1" ] && [ $1 != "core2" ] && [ $1 != "reg-master" ] && [ $1 != "reg-slave" ] && [ $1 != "static" ]; then
  echo "please specify which role: cores, core1, core2, reg-master, reg-slave or static";
  exit 1;
fi

####
####    do not EVER use the '--delete' option as the user data is in the synchronized directory scope
####

RSYNC_OPTIONS="--recursive --times --human-readable --verbose"

if [ $1 == "cores" ] || [ $1 == "core1" ]; then
  echo "Syncing core machine"

  echo "###############################"
  echo "Syncing co-pryv-li-exoscale-ch-01.pryv.net"
  echo "###############################"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' core core.yml run-core stop-containers 89.145.167.179:/var/pryv/pryv.li  --exclude ".DS_Store" --exclude ".*"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' core.logrotate.conf 89.145.167.179:/etc/logrotate.d/pryv
fi

if [ $1 == "cores" ] || [ $1 == "core2" ]; then
  echo "Syncing core machine"

  echo "###############################"
  echo "Syncing co-pryv-li-exoscale-ch-02.pryv.net"
  echo "###############################"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' core core.yml run-core stop-containers 89.145.166.17:/var/pryv/pryv.li --exclude ".DS_Store" --exclude ".*"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' core.logrotate.conf 89.145.166.17:/etc/logrotate.d/pryv
fi

if [ $1 == "reg-master" ]; then
  echo "Syncing master register"

  echo "###############################"
  echo "Syncing reg-pryv-li-exoscale-ch-01.pryv.net"
  echo "###############################"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' reg-master reg-master.yml run-reg-master stop-containers 185.19.30.198:/var/pryv --exclude ".DS_Store" --exclude ".*"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' reg.logrotate.conf 185.19.30.198:/etc/logrotate.d/pryv
fi

if [ $1 == "reg-slave" ]; then
  echo "Syncing slave register"

  echo "###############################"
  echo "Syncing streg-azure-nl-02.pryv.net (old machine)"
  echo "###############################"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' reg-slave reg-slave.yml run-reg-slave stop-containers client-streg-azure-nl-02.ovpn connect-vpn-client-to-master streg-azure-nl-02.pryv.net:/var/pryv --exclude ".DS_Store" --exclude ".*"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' reg.logrotate.conf streg-azure-nl-02.pryv.net:/etc/logrotate.d/pryv
fi

if [ $1 == "static" ]; then
  echo "Syncing static-web machine"

  echo "###############################"
  echo "Syncing sw-pryv-li-exoscale-ch-01.pryv.net"
  echo "###############################"

  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' static static.yml run-static stop-containers 185.19.28.119:/var/pryv --exclude ".DS_Store" --exclude ".*"
  rsync $RSYNC_OPTIONS -e ssh --rsync-path='sudo rsync' static.logrotate.conf 185.19.28.119:/etc/logrotate.d/pryv
fi
